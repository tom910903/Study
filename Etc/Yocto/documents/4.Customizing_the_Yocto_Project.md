# 4장. **Yocto 프로젝트 커스터마이징**

* [4-1 이미지에 새 패키지 추가하기](#4-1-이미지에-새-패키지-추가하기)
* [4-2 기존 레시피 수정하기](#4-2-기존-레시피-수정하기)
* [4-3 사용자 지정 레시피 생성](#4-3-사용자-지정-레시피-생성)
* [4-4 기본 빌드 구성 재정의](#4-4-기본-빌드-구성-재정의)

## 4-1 이미지에 새 패키지 추가하기  
  Yocto는 아주 유연하고 확장 가능한 프레임워크를 제공한다.  
  즉, 이미지에 새 패키지를 추가하기 매우 편리하다.

  * Yocto의 패키지 이해하기  
    Yocto 프로젝트 용어에서 패키지는 소프트웨어 구성 요소를 나타내는 파일 및 메타데이터 모음을 의미한다.  
    패키지에는 소프트웨어 컴포넌트를 빌드하고 설치하는 데 필요한 소스 코드, 라이브러리, 구성 파일 및 스크립트가 포함된다.  

  * 패키지 찾기 및 추가하기  
    Yocto 프로젝트 이미지에 새 패키지를 추가하려면 먼저 추가하려는 패키지를 찾아야 한다.  
    일반적인 소프트웨어 구성 요소에 대해 미리 빌드된 수천 개의 레시피가 포함된 Yocto 프로젝트의 레시피 레포지토리에서 패키지를 검색할 수 있다.  
    추가하려는 패키지를 찾았다면 Yocto 프로젝트 작업 영역에 새 레시피 파일을 추가하여 빌드 환경에 추가할 수 있다.  
    레시피 파일은 패키지를 빌드하고 설치하는 방법을 지정하는 스크립트이다.

  * 레시피 파일 만들기  
    새 레시피 파일을 만들려면 텍스트 편집기를 사용하여 확장자가 `.bb`인 새 파일을 만들어야 한다.  
    파일 이름은 추가하려는 패키지의 이름을 따서 지정한다.  
    그리고 레시피 파일에 패키지의 이름, 버전, 패키지를 다운로드할 수 있는 소스 URL을 지정한다.  
    또한 패키지에 포함된 종속성과 설정해야 하는 빌드 옵션도 지정해야 한다.

  * 패키지 빌드하기  
    레시피 파일을 만들었으면 레시피 파일 이름을 인수로 사용하여 bitbake 명령(`bitbake <패키지명>`)을 실행하여 패키지를 빌드할 수 있다.  
    이렇게 하면 소스 코드를 가져와 컴파일하고 대상 디바이스에 설치할 수 있는 바이너리 패키지가 생성된다.
  
  * 이미지에 패키지 추가하기  
    패키지를 `local.conf` 파일의 `IMAGE_INSTALL` 변수에 추가하여 Yocto 프로젝트 이미지에 추가한다.  

## 4-2 기존 레시피 수정하기
  Yocto 프로젝트의 주요 기능 중 하나는 기존 레시피를 수정하여 빌드 프로세스를 사용자 정의하거나 기존 패키지에 새로운 기능을 추가할 수 있는 기능이다. 

  * Yocto의 레시피 이해하기  
    Yocto 프로젝트 용어에서 레시피는 패키지를 빌드하고 설치하는 방법을 지정하는 스크립트이다.  
    레시피에는 일반적으로 패키지 이름, 버전, 소스 URL 및 설정해야 하는 빌드 옵션과 같은 정보가 포함된다.  
    레시피는 일반적인 소프트웨어 구성 요소에 대해 미리 빌드된 수천 개의 레시피가 포함된 Yocto 프로젝트의 레시피 리포지토리에 저장된다.

  * 수정할 레시피 찾기  
    기존 레시피를 수정하려면 Yocto 프로젝트의 레시피 저장소에서 해당 레시피 파일을 찾아야 한다.  
    빌드 환경의 모든 layer와 레시피를 나열하는 `bitbake-layers` 명령을 사용하여 레시피를 검색할 수 있다.  
    레시피 파일을 찾으면 layer나 작업 공간에 복사하여 원본 레시피에 영향을 주지 않고 수정할 수 있다.

  * 레시피 수정하기  
    레시피를 수정하려면 텍스트 편집기를 사용하여 레시피 파일을 열어야 한다.  
    그런 다음 소스 URL을 업데이트하거나 빌드 옵션을 수정하거나 패키지에 새 파일을 추가하는 등 레시피에 필요한 변경을 수행할 수 있다.  
    레시피에 패치를 추가하여 패키지의 소스 코드를 수정할 수도 있다.

  * 수정된 레시피 빌드하기  
    레시피를 수정한 후에는 레시피 파일 이름을 인수로 사용하여 bitbake 명령(`bitbake <패키지명>`)을 실행하여 패키지를 빌드할 수 있다.  
    이렇게 하면 소스 코드를 가져오고, 패치를 적용하고, 패키지를 컴파일하고, 대상 장치에 설치할 수 있는 바이너리 패키지가 생성된다.

  * 수정된 패키지 테스트하기  
    수정된 패키지를 빌드한 후에는 예상대로 작동하는지 테스트해야 한다.  
    대상 디바이스에 패키지를 설치하고 필요한 테스트 또는 벤치마크를 실행하여 테스트할 수 있다.

  * 커뮤니티에 다시 기여하기  
    기존 레시피를 크게 수정한 경우, 변경 사항을 Yocto 프로젝트 커뮤니티에 다시 기여하는 것을 고려할 수 있다.  
    이렇게 하면 레시피의 품질을 개선하고 다른 사람들이 더 쉽게 사용하고 수정하는 데 도움이 될 수 있다.
  
## 4-3 사용자 지정 레시피 생성
  다음으로 직접 만든 어플리케이션(라이브러리 등)을 추가하기 위한 과정을 알아보자.  

  1. 사용자 지정 레시피 만들기  
    사용자 지정 레시피를 만들려면 Yocto 프로젝트 작업 공간의 적절한 위치에 레시피 파일을 만들어야 한다.  
    레시피 파일 이름은 패키지 이름으로 지정하고 파일 확장자는 ".bb"로 지정한다.  
    예를 들어 "myapp"라는 패키지에 대한 레시피를 생성하는 경우, 레시피 파일 이름은 "myapp.bb" 또는 "myapp_{version}.bb"여야 한다.  
    레시피 파일의 내용에는 패키지 이름, 버전, 라이선스 등 패키지에 대한 메타데이터가 포함되어야 한다.  
    또한 패키지의 소스 위치, 적용해야 하는 패치 및 설정해야 하는 구성 옵션도 포함되어야 한다.
    다음은 "myapp"이라는 패키지에 대한 레시피 파일의 예다.
      ``` bash
      SUMMARY = "A simple hello world application"
      LICENSE = "MIT"
      LIC_FILES_CHKSUM = "file://LICENSE;md5=1234567890abcdef"

      SRC_URI = "git://github.com/myapp/myapp.git"

      S = "${WORKDIR}/git"

      inherit cmake

      DEPENDS = "openssl"

      PACKAGE_ARCH = "${MACHINE_ARCH}"

      FILES:${PN} += "/usr/bin/"

      do_compile() {
          oe_runmake
      }

      do_install() {
          install -d ${D}/usr/bin
          install -m 0755 ${S}/myapp ${D}/usr/bin
      }
      ```
      위에서 사용된 변수와 함수에 대한 설명이다.  
      * SUMMARY: 패키지에 대한 간략한 설명  
      * LICENSE: 패키지가 배포되는 라이선스  
      * LIC_FILES_CHKSUM: 라이선스 파일이 수정되지 않았는지 확인하기 위한 체크섬  
      * SRC_URI: 패키지의 소스 코드를 찾을 수 있는 URI  
      * S: 소스 코드가 추출된 빌드 머신의 위치  
      * inherit: 레시피가 다른 레시피 또는 클래스로부터 특정 동작 및 설정을 상속하도록 지정  
      위의 경우 CMake로 패키지 빌드를 지원하는 cmake 클래스의 동작을 상속한다.  
      * DEPENDS: 이 패키지가 의존하는 패키지를 지정  
      * PACKAGE_ARCH: 패키지의 대상 아키텍처  
      * FILES_${PN}: 패키지에 포함되어야 하는 파일을 지정  
      * do_compile(): 빌드 프로세스 중에 소스 코드를 컴파일하기 위해 호출되는 함수  
      * oe_runmake: make 명령을 실행하여 패키지를 빌드하는 BitBake 함수    
      * do_install(): 빌드 프로세스 중에 호출되어 대상 시스템에 패키지를 설치하는 함수  
      * install: 대상 시스템에 파일을 복사하는 명령  
      * ${D}: 대상 시스템의 루트 디렉터리를 나타내는 BitBake 변수  

  2. 이미지에 레시피 추가하기
    사용자 정의 레시피를 만들었으면 이미지 레시피에 추가해야 한다.  
    이미지 레시피에 패키지를 추가하기 위해서는 이미지 레시피의 `IMAGE_INSTALL` 변수에 패키지 이름을 포함시켜야 한다.
    예를 들어 이미지에 "myapp" 패키지를 포함하려면 이미지 레시피에 아래와 같이 추가한다.
      ``` bash
      IMAGE_INSTALL += "myapp"
      ```

  3. 사용자 정의 패키지로 이미지 빌드하기  
    이미지 레시피에 사용자 정의 레시피를 추가한 후 비트베이크 명령을 사용하여 정상적으로 이미지를 빌드할 수 있다.  
    bitbake 명령은 자동으로 패키지의 소스를 가져와서 레시피 파일의 지침에 따라 빌드한다.  
    위 예시에서 사용한 myapp만 빌드하려면 `bitbake myapp`이라는 명령어를 통해 myapp만 빌드하여 확인할 수 있다.
    
## 4-4 기본 빌드 구성 재정의  

  1. 기본 빌드 구성 이해하기  
    Yocto 프로젝트의 기본 빌드 구성은 빌드 디렉터리의 다양한 파일에 저장된다.  
    이러한 구성은 프로젝트 또는 레시피 수준에서 재정의할 수 있다.  
    구성 파일은 레이어로 구성되어 있으며 각 레이어마다 고유한 구성 세트를 제공한다.

  2. 프로젝트 수준에서 기본 빌드 구성 재정의하기  
    프로젝트 수준에서 기본 빌드 구성을 재정의하려면 프로젝트의 conf 디렉터리에 새 구성 파일을 만듭니다.  
    예를 들어 기본 `MACHINE` 설정을 재정의하려면 프로젝트의 conf 디렉터리에 `local.conf`라는 파일에 `MACHINE = "my_machine"`를 추가한다.
    이때, `"my_machine"`은 MACHINE 빌드하려는 머신의 이름이다.  

      * `MACHINE` : 빌드의 대상 하드웨어 플랫폼을 지정 (커널 구성, 부트로더 및 기타 플랫폼별 설정을 결정)  
      * `DISTRO` : 빌드의 대상 배포(예: Poky 또는 OpenEmbedded)를 지정 최종 이미지에 포함될 패키지 세트와 해당 버전을 결정  
      * `PACKAGE_CLASSES` : 빌드에 사용할 패키지 형식의 유형(예: rpm 또는 deb)을 지정(대상 시스템에 패키지를 설치하는 데 사용할 패키지 관리자를 결정)  
      * `IMAGE_FSTYPES` : 대상 이미지의 루트 파일 시스템에 사용할 파일 시스템 유형(예: ext3 또는 ext4)을 지정
      * `BB_NUMBER_THREADS` 및 `PARALLEL_MAKE` : 이 변수는 BitBake 빌드 시스템에서 패키지를 컴파일하는 데 사용할 병렬 빌드 스레드 수를 지정
      * `DEFAULTTTUNE` : 이 변수는 대상 시스템의 기본 CPU 아키텍처(예: ARM 또는 x86)를 지정

  3. 레시피 수준에서 기본 빌드 구성 재정의하기  
    레시피 수준에서 기본 빌드 구성을 재정의하려면 레시피의 디렉터리에 새 구성 파일을 만든다.  
    예를 들어 bash 레시피의 기본 병렬 메이크 스레드 수를 재정의하려면 레시피의 디렉터리에 `bash_%.bbappend`라는 파일을 만들고 `PARALLEL_MAKE = "-j 4"`를 추가한다.  