# 3장. **Bitbake 순서**

  * [3-1 User 설정](#3-1-user-설정)
  * [3-2 Source 준비](#3-2-source-준비)
  * [3-3 설정, 컴파일, 스테이징](#3-3-설정-컴파일-스테이징)
  * [3-4 패키지 분류](#3-4-패키지-분류)
  * [3-5 이미지 생성](#3-5-이미지-생성) 
  * [3-6 SDK 생성](#3-6-sdk-생성)

Bitbake를 이해하려면 아래 그림을 이해하는 것이 매우 중요하다.  
단계별로 하나씩 알아보자.  
<center><img src="../images/2.Getting_Started/Yocto_Project_workflow.png" width="95%" height="75%"></center>

## 3-1 User 설정  
  <center><img src="../images/3.Bitbake_Process/user-configuration.png" width="95%" height="75%"></center>  

  비트베이크는 빌드를 완료하기 위해 몇 가지 기본 구성 파일이 필요하다.  
  이러한 파일은 *.conf 파일이다.  
  필요한 최소한의 파일은 소스 디렉터리의 `build/conf` 디렉터리에 예제 파일로 존재한다.  
  Poky 내부의 `meta-poky` layer에는 예제 구성 파일이 있는 conf 디렉터리가 포함되어 있다.  
  이러한 예제 파일은 빌드 환경 스크립트인 `oe-init-build-env`를 소싱할 때 실제 구성 파일을 만들기 위한 기초로 사용된다.  
  빌드 환경 스크립트를 소싱하면 빌드 디렉터리가 없는 경우 빌드 디렉터리가 생성된다.  
  비트베이크는 빌드 중 모든 작업에 빌드 디렉터리를 사용한다.  
  빌드 디렉터리에는 conf 디렉터리가 있으며, 이 디렉터리에는 `local.conf` 및 `bblayers.conf` 구성 파일의 기본 버전이 포함되어 있다.  
  이러한 기본 구성 파일은 빌드 환경 설정 스크립트를 소싱할 때 빌드 디렉터리에 버전이 아직 존재하지 않는 경우에만 생성된다.

  `scripts/oe-setup-builddir` 스크립트는 `$TEMPLATECONF` 변수를 사용하여 찾을 샘플 구성 파일을 결정한다.  
  `local.conf` 파일은 빌드 환경을 정의하는 많은 기본 변수를 제공합니다.  
  다음은 몇 가지 목록이다.  
  빌드 환경 스크립트에 의해 생성된 `local.conf` 파일의 기본 구성을 확인하려면 meta-poky layer에서 `local.conf.sample`을 참조하자.  
  ```
  MACHINE : 대상 머신 선택
  DL_DIR : 다운로드 디렉토리
  SSTATE_DIR : 공유 상태(Shared State) 디렉토리
  TMPDIR : 빌드 output
  DISTRO : 배포 정책
  PACKAGE_CLASSES : 패키징 포맷
  SDKMACHINE : SDK 타겟 아키텍처
  EXTRA_IMAGE_FEATURES : 추가 이미지 패키지
  ```
  `conf/local.conf` 파일에 설정된 구성은 `conf/site.conf` 및 `conf/auto.conf` 구성 파일에서도 설정할 수 있다.  
  `bblayers.conf` 파일은 빌드 중에 어떤 레이어를 고려할지 `BitBake`에 알려준다.  
  기본적으로 이 파일에 나열된 레이어에는 빌드 시스템에 필요한 최소한의 레이어가 포함된다.  
  그러나 사용자가 만든 사용자 정의 레이어는 수동으로 추가해야 한다. 

  `site.conf` 및 `auto.conf` 파일은 환경 초기화 스크립트에 의해 생성되지 않는다.  
  `site.conf` 파일을 원한다면 직접 만들어야 한다.  
  `auto.conf` 파일은 일반적으로 자동 빌더에 의해 생성된다.

  site.conf
  ```
  conf/site.conf 구성 파일을 사용하여 여러 빌드 디렉터리를 구성할 수 있다.
  예를 들어 여러 빌드 환경이 있고 몇 가지 공통 기능을 공유한다고 가정해 보자.
  여기에서 이러한 기본 빌드 속성을 설정할 수 있다.
  좋은 예로 PACKAGE_CLASSES 변수를 통해 사용할 패키징 형식을 들 수 있다.
  ```
  auto.conf
  ```
  이 파일은 보통 자동 빌더에 의해 생성되고 쓰여진다.
  이 파일에 입력되는 설정은 일반적으로 conf/local.conf 또는 conf/site.conf 파일에서 찾을 수 있는 것과 동일하다.
  ```
  모든 구성 파일을 편집하여 특정 빌드 환경을 추가로 정의할 수 있다.
  이 프로세스는 그림에서 "User Configuration Edits" 상자로 표시된다.

## 3-2 Source 준비  
  레시피를 빌드하는 첫 번째 단계는 소스 코드를 가져오고 압축을 푸는 것이다.  
  <center><img src="../images/3.Bitbake_Process/source-fetching.png" width="75%" height="75%"></center>

  `do_fetch()` 및 `do_unpack()` 작업은 소스 파일을 가져와 빌드 디렉터리에 압축을 푼다.  

  레시피의 `SRC_URI` 문에 포함된 모든 로컬 파일(예: file://)에 대해 OpenEmbedded 빌드 시스템은 해당 레시피에 대한 파일의 체크섬을 가져와 `do_fetch()` 태스크의 서명에 체크섬을 삽입한다.  
  로컬 파일이 수정된 경우 `do_fetch()` 작업 및 해당 파일에 종속된 모든 작업이 다시 실행된다.  
  기본적으로 모든 작업은 정의된 구조를 가진 빌드 디렉토리에서 수행된다. 

  각 레시피에는 빌드 디렉토리에서 압축을 푼 소스 코드가 있는 영역이 있다.  
  `S` 변수는 레시피의 압축 해제된 소스 코드가 있는 이 영역을 가리킨다.  
  특정 레시피에 대한 해당 디렉터리의 이름은 여러 가지 변수를 통해 정의된다.  
  앞의 그림과 다음 목록은 빌드 디렉터리의 계층 구조를 설명한다.

  ```
  TMPDIR: 빌드 중에 OpenEmbedded 빌드 시스템이 모든 작업을 수행하는 기본 디렉터리(tmp 디렉터리)
  PACKAGE_ARCH: 빌드된 패키지의 아키텍처
  TARGET_OS: 대상 디바이스의 운영 체제
  PN: 패키지를 빌드하는 데 사용된 레시피의 이름(입력 파일의 컨텍스트에서 사용되는 경우 PN은 레시피의 이름)
  WORKDIR: OpenEmbedded 빌드 시스템이 레시피를 빌드하는 위치
  PV: 패키지를 빌드하는 데 사용되는 레시피의 버전
  PR: 패키지를 빌드하는 데 사용된 레시피의 개정판
  S: 특정 레시피의 압축이 풀린 소스 파일을 포함
  BPN: 패키지를 빌드하는 데 사용된 레시피의 이름(BPN 변수는 PN 변수의 버전이지만 일반적인 접두사와 접미사가 제거된 버전이다.)
  PV: 패키지를 빌드하는 데 사용된 레시피의 버전
  ```
  
## 3-3 설정, 컴파일, 스테이징  
## 3-4 패키지 분류  
## 3-5 이미지 생성  
## 3-6 SDK 생성