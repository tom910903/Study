# 5장. **Yocto 프로젝트 더 알아보기**

* [5-1 이미지 크기 및 성능 최적화](#5-1-이미지-크기-및-성능-최적화)
* [5-2 Yocto 프로젝트 빌드 Debugging](#5-2-yocto-프로젝트-빌드-debugging)
* [5-3 Yocto 프로젝트와 지속적 통합 도구 통합하기](#5-3-yocto-프로젝트와-지속적-통합-도구-통합하기)
* [5-4 사용자 정의 플러그인 및 스크립트로 Yocto 프로젝트 확장하기](#5-4-사용자-정의-플러그인-및-스크립트로-yocto-프로젝트-확장하기)
* [5-5 Yocto 프로젝트 빌드 시간 개선](#5-5-yocto-프로젝트-빌드-시간-개선)

## 5-1 이미지 크기 및 성능 최적화  
  Yocto 프로젝트는 맞춤형 임베디드 Linux 배포판을 구축할 수 있으며, 쉽게 이미지의 크기와 성능을 최적화할 수 있다.
  
  * 이미지 크기와 성능 이해  
    이미지 크기와 성능은 Yocto Project 이미지를 최적화할 때 고려해야 할 두 가지 중요한 요소이다.  
    이미지 크기는 대상 장치에 로드되는 이미지 파일의 크기를 나타낸다.  
    임베디드 기기의 저장 용량이 제한되어 있는 경우가 많기 때문에 굉장히 중요하다.  
    또한, 성능은 기기의 속도와 응답성을 의미한다.  
    이미지 크기와 마찬가지로 임베디드 디바이스는 처리 능력이 제한되어 있는 경우가 많기 때문에 성능 역시 최적화가 중요하다.

  1. 이미지 크기 최적화를 위한 팁  
      1. 불필요한 패키지와 기능 제거  
        이미지 크기를 줄이는 가장 쉬운 방법 중 하나는 불필요한 패키지와 기능을 제거하는 것이다.  
        이미지에 필요하지 않은 패키지와 기능을 제외하기 위해 `PACKAGE_EXCLUDE` 및 `IMAGE_FEATURES` 변수를 사용한다.
        만약 이미지에서 "nano" 텍스트 편집기를 제외하려면 `local.conf` 파일에 다음 줄을 추가한다.
          ``` bash
          PACKAGE_EXCLUDE = "nano"
          ```

      2. 파일 압축하기  
        파일을 압축하면 이미지 크기를 크게 줄일 수 있다.  
        루트 파일 시스템과 커널 이미지를 압축하려면 `local.conf` 파일에서 `COMPRESS_IMAGES` 변수를 사용한다.  
          ```
          COMPRESS_IMAGES = "1"
          ```

      3. 디버그 정보 제거  
        디버그 정보는 이미지에서 많은 공간을 차지한다.  
        디버그 정보를 제거하려면 `local.conf` 파일에서 `DEBUG_BUILD` 및 `DEBUG_OPTIMIZATION` 변수를 사용한다.
          ```
          DEBUG_BUILD = "0"
          DEBUG_OPTIMIZATION = "-O2"
          ```
  2. 성능 최적화를 위한 팁  
      1. 가벼운 데스크톱 환경 사용  
        경량 데스크톱 환경은 임베디드 디바이스의 성능을 향상시킬 수 있다.  
        XFCE 또는 LXDE와 같은 데스크톱 환경 사용을 고려하자.
      2. 경량 창 관리자 사용  
        경량 창 관리자도 임베디드 디바이스의 성능을 향상시킬 수 있다.  
        Openbox 또는 Fluxbox와 같은 창 관리자를 사용하는 것이 좋다.
      3. 최소한의 커널 구성 사용  
        최소한의 커널 구성으로 부팅 시간과 전반적인 성능을 개선할 수 있다.  
        필요한 커널 기능만 활성화하려면 `local.conf` 파일에서 `KERNEL_FEATURES` 변수를 사용하자.      
          ```
          KERNEL_FEATURES = "features/netfilter/netfilter-core.cfg features/netfilter/netfilter-defaults.cfg"
          ```

## 5-2 Yocto 프로젝트 빌드 Debugging
  Debugging은 개발자가 빌드 프로세스에서 문제를 식별하고 해결하는 데 도움이 되며, 결과적으로 더 안정적이고 신뢰할 수 있는 빌드로 이어진다.  
  Yocto 프로젝트 빌드 Debugging을 위한 다양한 기술에 대해 알아보자.

  1. Logging 및 Debugging 도구 사용하기  
      * Logging  
        기본적으로 Yocto 프로젝트는 빌드 프로세스 중에 많은 로그를 생성한다.  
        이러한 로그는 빌드 프로세스의 다양한 단계에 대한 정보를 포함하므로 Debugging에 유용하다.
      * Debugging 도구  
        Yocto 프로젝트에서 사용할 수 있는 Debugging 도구는 gdb, strace, valgrind 등 여러 가지가 있다.  
        이러한 도구는 세분화 오류 및 메모리 누수와 같은 빌드 프로세스의 문제를 식별하는 데 도움을 준다.

  2. Debugging 플래그 활성화  
    Yocto 프로젝트는 빌드 프로세스 중에 활성화할 수 있는 여러 Debugging 플래그를 제공한다.  
    이러한 플래그에는 `debug-tweaks`, `debug-pkgs`, `debug-build`가 포함된다.  
    이러한 플래그를 활성화하면 빌드 프로세스에서 문제를 식별하는 데 도움이 될 수 있다.

  3. devtool 사용  
    devtool은 레시피 개발 및 Debugging에 사용할 수 있는 Yocto 프로젝트에서 제공하는 도구이다.  
    레시피를 수정하고 별도의 작업 공간에서 빌드하는 기능을 포함한 여러 기능을 제공한다.

  4. 빌드 히스토리 사용  
    Yocto 프로젝트는 빌드 히스토리 기능을 제공하여 빌드 프로세스에서 변경 사항을 추적하고 문제를 식별하는 데 사용할 수 있다. 이 기능은 `local.conf` 파일에 다음 줄을 추가하여 활성화할 수 있다.
      ```
      INHERIT += "buildhistory"
      ```

## 5-3 Yocto 프로젝트와 지속적 통합 도구 통합하기  
Yocto Project는 굉장히 유용하고 유연한 솔루션을 제공한다.  
하지만 Yocto Project 이미지를 빌드하고 테스트하는 것은 시간이 많이 걸리고 오류가 발생하기 쉬운 프로세스이며, 특히 수동으로 수행할 경우 더욱 그렇다.  
지속적 통합(CI) 도구를 사용하면 프로세스를 자동화하고 Yocto Project 이미지를 빌드하고 테스트하는 더 빠르고 안정적인 방법을 제공할 수 있다.  

1. Yocto 프로젝트와 Jenkins 통합하기  
  Jenkins는 Yocto 프로젝트와 쉽게 통합할 수 있는 인기 있는 오픈소스 CI 도구이다.  
  설정 방법은 다음과 같다.
    1. Linux 배포판에 Jenkins를 설치한다.  
    2. Jenkins Yocto Project 플러그인을 설치한다.  
    이 플러그인을 사용하면 Jenkins를 사용하여 Yocto Project 이미지를 빌드할 수 있다.
    3. 새 Jenkins 작업을 생성하고 Yocto 프로젝트 이미지를 빌드하도록 구성한다.  
    "Execute shell" 빌드 단계를 사용하여 필요한 Yocto 프로젝트 명령을 실행할 수 있다.
    4. 빌드 프로세스를 트리거하려는 Git 커밋 또는 기타 이벤트에서 트리거되도록 작업을 구성한다.

2. Yocto 프로젝트와 Travis CI 통합하기  
  Travis CI는 Yocto 프로젝트 이미지를 빌드하고 테스트하는 데 사용할 수 있는 인기 있는 클라우드 기반 CI 도구이다.  
  설정 방법은 다음과 같다.
    1. Travis CI 계정에 가입한다.
    2. Yocto 프로젝트 리포지토리에 .travis.yml 파일을 생성한다.  
    이 파일에는 Travis CI가 Yocto 프로젝트 이미지를 빌드하고 테스트하는 데 필요한 구성이 포함되어 있다.
    3. .travis.yml 파일을 리포지토리에 푸시하고 Travis CI에서 빌드를 트리거한다.
    4. 빌드 프로세스를 모니터링하고 발생하는 오류를 수정한다.

3. Yocto 프로젝트와 CircleCI 통합하기  
  CircleCI는 Yocto 프로젝트 이미지를 빌드하고 테스트하는 데 사용할 수 있는 클라우드 기반 CI 도구이다.  
  설정 방법은 다음과 같다.
    1. CircleCI 계정에 가입한다.
    2. Yocto 프로젝트 리포지토리에 .circleci/config.yml 파일을 생성한다.  
    이 파일에는 CircleCI가 Yocto 프로젝트 이미지를 빌드하고 테스트하는 데 필요한 구성이 포함되어 있다.
    3. .circleci/config.yml 파일을 리포지토리에 푸시하고 CircleCI에서 빌드를 트리거한다.
    4. 빌드 프로세스를 모니터링하고 발생하는 오류를 수정한다.

Yocto Project를 CI와 통합하면 보다 효율적이고 안정적인 방법으로 Yocto Project 이미지를 빌드하고 테스트할 수 있다.  
빌드 및 테스트 프로세스를 자동화함으로써 개발자는 시간을 절약하고 오류의 위험을 줄일 수 있다.  
위에서 언급한 Jenkins, Travis CI, CircleCI와 같은 CI 도구 뿐만 아니라 다른 CI 도구를 사용할 수 있으며, 이를 통해 개발 프로세스를 간소화할 수 있다.

## 5-4 사용자 정의 플러그인 및 스크립트로 Yocto 프로젝트 확장하기
  Yocto 프로젝트는 사용자 정의 플러그인과 스크립트를 작성하여 특정 요구사항을 충족하도록 확장할 수 있다.
  
  1. 사용자 정의 플러그인 및 스크립트 이해하기  
    사용자 정의 플러그인과 스크립트는 빌드 프로세스 중에 특정 작업을 수행하기 위해 Yocto 프로젝트에 추가할 수 있다.  
    플러그인은 일반적으로 파이썬으로 작성되며 기존 Yocto 도구의 기능을 확장하는 데 사용된다.  
    반면 스크립트는 빌드 환경 내에서 호출할 수 있는 독립 실행형 프로그램이다.

  2. 사용자 지정 플러그인 추가하기  
    Yocto 프로젝트에 커스텀 플러그인을 추가하려면 `meta-mycustomlayer/recipes-core/mycustomlayer/` 디렉터리에 파일 이름이 .bb로 끝나는 새 레시피를 생성한다. `mycustomlayer` 디렉터리에 files라는 하위 디렉터리를 만들고 필요한 파일을 여기에 배치합니다. .bb 파일에서 종속성, 위치 및 Python 모듈에 대한 참조를 지정하여 플러그인을 정의한다.  
    예를 들면 비트베이크 도구의 동작을 수정하는 사용자 지정 플러그인을 만들고 싶다고 가정해 보자.  
    이 경우 `meta-mycustomlayer/recipes-core/mycustomlayer/` 디렉터리에 다음과 같은 내용으로 `mycustomplugin.bb`라는 파일을 만들 수 있다.
      ``` bash
      SUMMARY = "My Custom Bitbake Plugin"
      DEPENDS += "python3"
      LICENSE = "MIT"
      SRC_URI = "file://mycustomplugin.py"
      S = "${WORKDIR}"
      inherit python3native

      PYTHONPATH:prepend := "${WORKDIR}/"
      ```
      여기서는 파이썬 3에 의존하고 mycustomplugin.py라는 파이썬 모듈을 참조하는 mycustomplugin이라는 플러그인을 정의한다.  
      또한 파이썬 코드를 찾을 수 있도록 현재 작업 디렉터리를 `PYTHONPATH`에 추가했다.

  3. 사용자 지정 스크립트 추가하기  
    Yocto 프로젝트에 사용자 지정 스크립트를 추가하려면 meta-`mycustomlayer/recipes-core/mycustomlayer/` 디렉터리에 적절한 이름과 확장자를 사용하여 새 파일을 생성한다.  
    파일에 스크립트의 동작과 필요한 입력을 정의한다.  
    예를 들어 파일의 내용을 출력하는 사용자 지정 스크립트를 만들어보자.  
    이 경우 `meta-mycustomlayer/recipes-core/mycustomlayer/` 디렉터리에 다음과 같은 내용으로 `printfile.sh`라는 파일을 만들 수 있다.
      ``` bash
      #!/bin/sh

      if [ $# -eq 0 ]; then
          echo "Usage: $0 <filename>"
          exit 1
      fi

      cat $1
      ```
      하나의 argument를를 받아 파일의 내용을 콘솔에 인쇄하는 `printfile.sh`라는 셸 스크립트를 정의하고 있다.

  4. 사용자 정의 플러그인 및 스크립트 사용하기  
    Yocto 프로젝트에 사용자 정의 플러그인과 스크립트를 추가한 후에는 레시피와 빌드에서 사용할 수 있다.  
    커스텀 플러그인을 사용하려면 레시피의 `DEPENDS` 변수에 해당 플러그인 참조를 추가하면 된다.  
    사용자 정의 스크립트를 사용하려면 레시피 내에서 스크립트를 실행하는 명령어를 사용하여 스크립트를 호출한다.  

## 5-5 Yocto 프로젝트 빌드 시간 개선
  Yocto 프로젝트를 사용해 보면 빌드 시간이 굉장히 오래걸린다는 것을 알것이다.  
  빌드가 완료될 때까지 몇 시간씩 기다리면 개발 속도가 느려지고 빠르게 반복하기가 어려워질 수 밖에 없다.  
  빌드 시간을 개선하고 개발 프로세스를 간소화하기 위한 방법을 알아보자.

  1. 빌드 설정 최적화  
    Yocto 프로젝트는 다양한 설정 옵션을 제공하며, 이러한 설정을 최적화하면 빌드 시간에 큰 영향을 미칠 수 있다.  
    고려해야 할 주요 설정 중 하나는 대상 아키텍처와 하드웨어를 지정하는 `MACHINE` 변수이다.  
    타겟 하드웨어와 일치하는 머신을 선택하면 불필요한 컴포넌트 빌드를 방지하고 빌드 프로세스를 간소화할 수 있다.  
    또한, 병렬 빌드 스레드 수를 설정할 수 있다.  
    기본적으로 Yocto 프로젝트 빌드는 단일 스레드를 사용하지만 이 수를 늘리면 빌드 시간을 크게 단축할 수 있다.  
    그러나 병렬 스레드 수를 늘리면 메모리 사용량이 증가하여 일부 시스템에서 빌드 오류가 발생할 수 있다는 점에 유의하자.

  2. 캐싱 사용  
    빌드 시간을 개선하는 가장 효과적인 방법 중 하나는 캐싱을 사용하는 것이다.  
    캐싱을 사용하면 오브젝트 파일이나 라이브러리 등 이전에 빌드한 아티팩트를 처음부터 다시 빌드하지 않고 재사용하여 빌드 속도를 높일 수 있다.  
    Yocto 프로젝트는 소스 미러와 상태 캐시의 두 가지 유형의 캐싱을 제공한다.  
    소스 미러 캐싱은 인터넷에서 소스 코드 아카이브를 다운로드하여 로컬에 저장하고, sstate 캐시는 여러 빌드에서 재사용할 수 있는 빌드 아티팩트를 캐시한다.  
    캐싱을 활성화하면 중복 빌드를 방지하고 개발 프로세스의 속도를 높일 수 있다.

  3. 병렬 빌드 사용  
    앞서 언급했듯이 병렬 빌드 스레드 수를 늘리면 빌드 시간을 단축하는 데 도움이 될 수 있다.  
    병렬 빌드를 사용하는 또 다른 방법은 `bitbake` 명령과 함께 `-b` 옵션을 사용하는 것이다.  
    이 옵션을 사용하면 비트베이크가 여러 패키지를 동시에 빌드할 수 있으므로 빌드 시간도 단축할 수 있다.

  4. 더 빠른 하드웨어 사용  
    때로는 가장 간단한 해결책이 가장 좋은 해결책일 수 있다.  
    빌드 시간이 지속적으로 길어진다면 더 빠른 하드웨어에 투자해야 할 때일 수 있다.  
    더 빠른 프로세서, 더 많은 RAM 또는 솔리드 스테이트 드라이브로 업그레이드하면 빌드 시간을 단축하고 개발 프로세스를 개선하는 데 도움이 될 수 있다.  
    
