# 4장. 커널 타이머 관리

  * [4-1 커널 타이머](#4-1-커널-타이머)
  * [4-2 jiffies란?](#4-2-jiffies란)

## 4-1 커널 타이머
  Kernel Timer는 스케줄링, 동기화, 이벤트 처리 등 다양한 시스템 레벨 작업을 담당하는 Linux Kernel의 필수적인 부분이다. 

  1. HZ란?  
      HZ는 타이머 인터럽트가 틱을 생성하는 속도를 정의하는 커널 구성 매개변수이다.  
      초당 타이머 인터럽트가 발생하는 회수를 지정한다.  
      예를 들어, HZ가 1000으로 설정된 경우 타이머 인터럽트는 초당 1000개의 틱을 생성한다.  
      HZ의 값은 커널 컴파일 시간에 설정되며 동적으로 변경할 수 없다.

  2. Soft IRQ의 타이머 서비스란?  
      Timer Service in SOFT IRQ는 커널이 이후에 실행할 작업을 예약할 수 있는 메커니즘이다.  
      SOFT IRQ 컨텍스트에서 실행되며, 다른 작업에 의해 중단될 수 있지만, 다음 사용자 수준 작업이 실행되기 전에 반드시 실행된다는 것을 보장한다.

  3. Soft IRQ 타이머 서비스와 동적 타이머란?  
      SOFT IRQ Timer Services는 SOFT IRQ 컨텍스트에서 실행되는 커널 서비스이다.  
      시스템 시계 업데이트 또는 네트워크 인터럽트 처리와 같이 이후에 실행할 작업을 예약하는 데 사용된다.

      Dynamic Timers는 런타임에서 작업을 동적으로 예약하고 취소할 수 있는 SOFT IRQ Timer Services의 일종이다.  
      `timer_setup` 함수를 사용하여 생성하고 `mod_timer`와 `del_timer` 함수를 사용하여 관리한다.

  4. 커널 타이머 용어 정리
      * 타이머 인터럽트 : 하드웨어 타이머 장치에 의해 생성되는 인터럽트
      * HZ : 타이머 인터럽트가 틱을 생성하는 빈도를 정의하는 커널 구성 매개변수
      * SOFT IRQ : 지연된 컨텍스트에서 커널 서비스를 실행할 수 있는 메커니즘
      * SOFT IRQ 타이머 서비스 : SOFT IRQ 컨텍스트에서 실행되는 커널 서비스
      * 다이나믹 타이머 : 런타임 중에 작업을 동적으로 예약하고 취소할 수 있는 SOFT IRQ 타이머 서비스 유형

## 4-2 jiffies란? 
  Jiffies는 Linux 커널에서 시간을 tick의 단위로 추적하는 시간 유지 메커니즘이다.  
  tick은 커널이 추적하는 가장 작은 시간 단위이며, 고정된 시간을 나타냔다.  
  대부분의 시스템에서 tick 비율은 1000 Hz로 설정되어 있으며, 이는 커널이 초당 1000번 jiffies 값을 업데이트한다는 것을 의미한다.

  1. jiffies와 jiffies_64 변수  
      jiffies 변수는 현재 tick 수를 보유하는 32비트 부호 없는 정수이다.  
      이 값은 최댓값에 도달하면 다시 0부터 세기 시작하므로 시간 간격을 계산할 때 문제가 될 수 있다.  
      이를 해결하기 위해 `jiffies_64` 변수가 도입되었으며, 이는 현재 tick 수를 보유하는 64비트 정수이다.

  2. jiffies 값은 누가 언제 증가시킬까?  
      jiffies 값은 커널의 타이머 인터럽트 핸들러에 의해 증가된다.  
      이 핸들러는 소프트 IRQ 시스템의 일부이다.  
      타이머 인터럽트는 시스템 상수 HZ에 의해 결정된 고정된 속도로 발생한다.

      HZ 값은 초당 타이머 인터럽트의 수를 나타낸다.  
      예를 들어, HZ가 1000으로 설정된 경우 타이머 인터럽트는 1밀리초마다 한 번 발생한다.

  3. msecs_to_jiffies() 함수  
      커널은 `msecs_to_jiffies()`라는 헬퍼 함수를 제공한다.  
      이 함수는 밀리초 단위의 시간 값을 해당하는 jiffies 수로 변환한다.  
      이 함수는 커널 타이머 및 기타 시간 관련 작업에 대한 시간 간격을 지정하는 데 유용하다.

      예를 들어, 500 밀리초 동안 타이머를 설정하려면 다음과 같이 사용할 수 있다.
      ``` c
      unsigned long timeout = msecs_to_jiffies(500);
      ```
      이렇게 하면 500 밀리초의 시간 값을 해당하는 jiffies 수로 변환하며, 이는 타이머 이벤트를 설정하는 데 사용할 수 있다.