# 2장. Interrupt

  * [2-1 Interrupt 란?](#2-1-interrupt-란)
  * [2-2 Interrupt Context](#2-2-interrupt-context)
  * [2-3 Interrupt Handler](#2-3-interrupt-handler)

## 2-1 Interrupt 란?
  1. Interrupt 란?  
      컴퓨팅에서 인터럽트는 장치나 프로그램에서 프로세서의 주의를 끌기 위해 프로세서에 보내는 신호를 말한다.  
      인터럽트가 트리거되면 프로세서는 현재 실행 중인 명령어 실행을 중단하고 인터럽트 서비스 루틴(ISR)이라고도 하는 인터럽트 처리 루틴으로 전환하여 들어오는 신호를 처리한다.

      인터럽트는 키보드, 마우스, 디스크와 같은 입력/출력 장치나 시스템 호출, 트랩, 예외와 같은 소프트웨어 이벤트 등 다양한 소스에서 발생할 수 있다.  
      인터럽트는 프로세서가 입력 또는 출력 작업이 완료될 때까지 기다리는 시간을 줄여 리소스를 보다 효율적으로 사용할 수 있게 해주므로 최신 컴퓨팅 시스템에서 필수적인 부분이다.

      인터럽트는 하드웨어 인터럽트와 소프트웨어 인터럽트의 두 가지 주요 유형으로 분류된다.  
      하드웨어 인터럽트는 외부 장치 또는 주변 장치에 의해 트리거되며 비동기식으로 간주되므로 예측할 수 없는 시간에 발생한다.  
      반면에 소프트웨어 인터럽트는 프로그램이나 시스템 호출에 의해 생성되며 동기식이기 때문에 특정 시간에 발생한다.

      인터럽트가 발생하면 프로세서는 먼저 프로그램 카운터와 레지스터를 포함한 현재 상태를 메모리에 저장한다.  
      그런 다음 인터럽트 처리를 담당하는 인터럽트 서비스 루틴을 메모리에 로드하고 프로그램 카운터를 ISR의 시작 주소로 설정한다.  
      그런 다음 ISR이 실행되고 완료되면 프로세서는 이전 상태로 복원하고 인터럽트된 프로그램을 계속 실행힌다.

      인터럽트는 시스템 성능과 안정성에 중요한 역할을 한다.  
      인터럽트는 효율적인 멀티태스킹을 가능하게 하여 프로세서가 리소스 낭비 없이 여러 작업을 동시에 처리할 수 있게 해준다.  
      또한 인터럽트는 프로세서가 예기치 않은 이벤트나 오류가 발생할 때 이를 처리할 수 있도록 하여 시스템 충돌 및 중단을 방지하는 데 도움이 된다.  

  2. 인터럽트 처리 과정  
    인터럽트 처리 프로세스에는 여러 단계가 포함된다.  

      <center><img src="../images/2.interrupt/Interrupt_Handling_Process.png" width="50%" height="75%"></center>

      1. 인터럽트 발생  
        인터럽트 처리 프로세스의 첫 번째 단계는 인터럽트 발생이다.  
        인터럽트는 키보드, 마우스 또는 디스크 드라이브와 같은 하드웨어 장치 또는 장치 드라이버 또는 운영 체제 서비스와 같은 소프트웨어 프로그램에 의해 발생할 수 있다.
      2. 인터럽트 알림  
        인터럽트가 발생하면 하드웨어 장치 또는 프로그램이 프로세서에 신호를 보내 인터럽트를 알린다.  
        이 신호는 일반적으로 장치 또는 프로그램을 프로세서에 연결하는 전용 회선인 하드웨어 인터럽트 라인을 통해 전송된다.
      3. 인터럽트 승인  
        프로세서는 인터럽트 신호를 승인하여 장치 또는 프로그램에 요청을 수신했음을 알려야한다.  
        이는 인터럽트 라인을 통해 승인 신호를 다시 전송하여 수행된다.
      4. 인터럽트 처리  
        인터럽트가 승인되면 프로세서는 인터럽트의 원인을 파악하고 적절한 인터럽트 핸들러 루틴을 실행해야 한다.  
        이 루틴은 인터럽트 요청을 처리하도록 특별히 설계된 코드 조각이다.
      5. 인터럽트 서비스  
        인터럽트 핸들러 루틴은 인터럽트 요청을 처리하는 데 필요한 작업을 수행한다.  
        여기에는 장치에서 데이터 읽기, 장치에 데이터 쓰기 또는 인터럽트 처리에 필요한 기타 작업 수행이 포함될 수 있다.
      6. 인터럽트 완료  
        인터럽트가 처리되면 프로세서는 인터럽트 요청이 완료되었음을 나타내는 신호를 장치 또는 프로그램에 보낸다.  
        그러면 장치 또는 프로그램이 정상 작동을 재개할 수 있다.

      요약하면 인터럽트 처리 프로세스에는 인터럽트 발생, 알림, 승인, 처리, 서비스 및 완료를 포함한 여러 단계가 포함된다.  
      각 단계는 컴퓨터 시스템의 효율적인 작동에 매우 중요하며 시스템 충돌이나 성능 문제를 방지하기 위해 신중하게 관리해야 한다.

## 2-2 Interrupt Context  
  1. 인터럽트 컨텍스트란?  
      인터럽트가 발생하면 프로세서는 현재 실행을 중지하고 인터럽트 핸들러 루틴으로 제어권을 넘긴다.  
      인터럽트 핸들러 루틴은 인터럽트 컨텍스트라는 특수 실행 컨텍스트에서 실행된다.  
      인터럽트 컨텍스트는 다른 시스템 작업을 방해하지 않고 빠르고 효율적으로 작업을 수행해야 하므로 프로세서의 일반 실행 컨텍스트와 다르다.

      * 인터럽트 컨텍스트의 특징  
        1. 인터럽트를 처리하는 동안에만 존재하는 임시 컨텍스트
        2. 프로세서의 일반 실행 컨텍스트보다 높은 우선 순위로 실행
        3. 시스템 리소스에 대한 액세스가 제한됨
        4. 다른 시스템 작업을 방해하지 않도록 작업을 빠르고 효율적으로 완료해야 함
        5. 중단된 프로세스의 상태를 저장하고 복원할 수 있어야 함

  2. 인터럽트 컨텍스트가 중요한 이유  
      인터럽트 컨텍스트가 중요한 이유는 시스템이 다른 시스템 작업을 방해하지 않고 인터럽트를 빠르고 효율적으로 처리할 수 있기 때문이다.  
      인터럽트는 하드웨어 오류나 사용자 입력과 같이 즉각적인 주의가 필요한 이벤트를 처리하는 데 사용된다.  
      만약, 인터럽트 핸들러 루틴이 작업을 완료하는 데 시간이 너무 오래 걸린다면 다른 시스템 작업을 방해하고 시스템 불안정을 초래할 수 있다.

      인터럽트 컨텍스트는 인터럽트된 프로세스의 상태를 저장하고 복원하는 메커니즘을 제공하므로 인터럽트 컨텍스트도 중요하다.  
      인터럽트가 발생하면 프로세서는 인터럽트된 프로세스의 상태를 저장하고 인터럽트 핸들러 루틴에 제어권을 넘긴다.  
      그러면 인터럽트 처리기 루틴은 해당 상태를 저장하고 필요에 따라 인터럽트된 프로세스의 상태를 수정할 수 있다.  
      인터럽트 처리기 루틴이 완료되면 인터럽트된 프로세스의 상태를 복원하고 제어권을 다시 인터럽트된 프로세스로 전송한다.

## 2-3 Interrupt Handler  
  인터럽트 핸들러는 인터럽트가 감지될 때 실행되는 작은 코드 조각이다.  
  인터럽트 핸들러는 운영 체제의 중요한 부분이며 입출력 작업, 장치 드라이버 및 기타 저수준 시스템 기능을 처리하는 데 사용된다.

  1. 인터럽트 핸들러란?  
      인터럽트 핸들러는 인터럽트에 대한 응답으로 실행되는 함수이다.  
      인터럽트가 발생하면 프로세서는 현재 프로그램의 실행을 중지하고 인터럽트 핸들러에 제어권을 넘긴다.  
      인터럽트 핸들러는 인터럽트를 처리하고 인터럽트된 프로그램에 제어권을 다시 돌려주는 역할을 한다.

      인터럽트 핸들러는 다음과 같은 다양한 시스템 기능에 사용된다.  

      * 장치 드라이버: 인터럽트 핸들러는 하드 드라이브, 키보드, 네트워크 어댑터와 같은 장치에서 생성된 하드웨어 인터럽트를 처리하는 데 사용된다.  
      * 입력/출력 작업: 인터럽트 핸들러는 디스크 읽기 및 쓰기, 네트워크 트래픽 및 기타 데이터 전송과 같은 입력/출력 작업을 관리하는 데 사용된다.
      * 시스템 호출: 인터럽트 핸들러는 사용자 프로그램이 만든 시스템 호출을 처리하는 데 사용된다.

  2. 인터럽트 벡터란?  
      인터럽트 벡터는 인터럽트를 해당 인터럽트 핸들러에 매핑하는 데 사용되는 데이터 구조이다.  
      각 인터럽트에는 고유한 인터럽트 번호가 할당되며, 이 번호는 인터럽트 벡터 테이블의 색인을 생성하는 데 사용된다.  
      인터럽트 벡터 테이블에는 가능한 각 인터럽트에 대한 인터럽트 핸들러 루틴에 대한 포인터 목록이 포함되어 있다.

      인터럽트가 트리거되면 CPU는 인터럽트 벡터 테이블에서 해당 항목을 조회하여 해당 인터럽트에 대한 인터럽트 핸들러 루틴의 주소를 찾는다.  
      그런 다음 이 주소가 프로그램 카운터(PC) 레지스터에 로드되어 CPU가 인터럽트 핸들러 코드를 실행하기 시작한다.

      인터럽트 벡터는 시스템의 하드웨어 계층과 소프트웨어 계층 사이에 추상화 수준을 제공하는 데 사용된다.  
      이를 통해 운영 체제는 기본 하드웨어 플랫폼에 관계없이 일관된 방식으로 인터럽트를 처리할 수 있다.

      * 인터럽트 벡터 테이블  
        인터럽트 벡터 테이블은 운영 체제에서 인터럽트를 관리하는 데 사용되는 데이터 구조이다.  
        인터럽트 번호를 해당 인터럽트 핸들러에 매핑하는 테이블이다.  
        인터럽트 벡터 테이블은 일반적으로 메모리에 저장되며 시스템 시작 중에 운영 체제에 의해 초기화된다.

        인터럽트 벡터 테이블의 각 항목에는 해당 인터럽트 번호에 대한 인터럽트 처리기 루틴의 주소가 포함되어 있다.  
        인터럽트가 발생하면 CPU는 인터럽트 번호를 사용하여 인터럽트 벡터 테이블을 인덱싱하여 인터럽트 핸들러 루틴의 주소를 찾는다.

      * 인터럽트 벡터 테이블 관리  
        인터럽트 벡터 테이블은 일반적으로 운영 체제에서 관리한다.  
        운영 체제는 시스템 시작 시 테이블을 초기화하고 런타임 중에 필요에 따라 업데이트할 책임이 있다.

        일부 운영 체제에서는 사용자 수준 프로그램이 인터럽트 벡터 테이블의 항목을 수정하여 자체 인터럽트 핸들러를 설치할 수 있다.  
        그러나 이는 일반적으로 특정 인터럽트에 대해서만 허용되며 일반적으로 권한이 있는 사용자로 제한된다.

## 인터럽트 핸들러의 호출 흐름  
  인터럽트 서비스 루틴(ISR)이라고도 하는 인터럽트 핸들러는 하드웨어 인터럽트 서비스를 담당하는 운영 체제 커널의 중요한 부분이다.  
  하드웨어 장치에서 인터럽트가 발생하면 프로세서는 현재 작업을 일시 중단하고 인터럽트 핸들러로 제어권을 전송한다.
  
  1. 인터럽트 벡터 테이블  
      하드웨어 장치가 인터럽트를 생성하면 프로세서에 신호를 보내면 프로세서는 현재 프로그램의 실행을 중지하고 인터럽트 벡터 테이블로 알려진 특정 메모리 위치로 점프한다.  
      인터럽트 벡터 테이블은 각 장치에 대한 인터럽트 핸들러의 메모리 주소를 포함하는 포인터 테이블이다.

      프로세서는 장치에서 생성된 인터럽트 번호를 사용하여 인터럽트 벡터 테이블에 인덱싱하고 해당 인터럽트 처리기의 주소를 가져온다.  
      그런 다음 인터럽트 핸들러가 실행되어 인터럽트를 처리한다.

  2. 인터럽트 핸들러의 호출 흐름  
    인터럽트 핸들러의 호출 흐름은 진입, 실행, 종료의 세 단계로 나눌 수 있다.

      1. 진입 단계  
          인터럽트가 발생하면 프로세서는 인터럽트된 태스크의 현재 상태를 스택에 저장하고 인터럽트 핸들러에 대한 새 실행 컨텍스트를 설정한다.  
          그런 다음 프로세서는 인터럽트 벡터 테이블에서 가져온 인터럽트 핸들러의 메모리 주소로 점프한다.

          인터럽트 핸들러가 입력되면 인터럽트 처리를 위한 환경을 설정하기 위해 몇 가지 중요한 작업을 수행한다.  
          이러한 작업에는 재귀적 인터럽트 처리를 방지하기 위해 동일한 유형의 추가 인터럽트를 비활성화하고, CPU 컨텍스트를 저장하고, 인터럽트를 승인하는 작업이 포함된다.

      2. 실행 단계  
          인터럽트 핸들러가 인터럽트 처리를 위한 환경을 설정하면 실제 인터럽트 처리 코드를 실행한다.  
          이 코드는 인터럽트를 생성한 특정 장치에 따라 달라질 수 있다.

          이 단계에서 인터럽트 핸들러는 장치에서 데이터를 읽고 메모리에 저장하거나 장치에 필요한 다른 작업을 수행한다.  
          또한 인터럽트 핸들러는 인터럽트 컨트롤러에 인터럽트 종료(EOI) 신호를 전송하여 인터럽트 처리 프로세스가 끝났음을 알린다.

      3. 종료 단계  
          인터럽트 처리 코드가 실행된 후 인터럽트 핸들러는 필요한 정리 작업을 수행하고 진입 단계에서 저장된 CPU 컨텍스트를 복원한다.  
          이러한 작업에는 인터럽트를 다시 활성화하고 인터럽트된 작업의 실행을 재개하는 작업이 포함된다.

          인터럽트 처리기가 정리 작업을 완료하면 중단된 작업으로 제어권이 반환되고 시스템이 정상 작동을 재개한다.

  3. 인터럽트 핸들러 등록 과정  
      1. 인터럽트 핸들러 함수 정의  
        인터럽트 핸들러를 등록하는 첫 번째 단계는 인터럽트를 처리할 함수를 정의하는 것이다.  
        이 함수는 처리할 인터럽트 번호와 일치하는 올바른 서명을 가져야 한다.  
        Linux 커널에서 인터럽트 핸들러는 `irqreturn_t` 반환 유형으로 선언되며 인터럽트 번호와 데이터 구조에 대한 포인터라는 두 가지 인수를 받는다.
          * [(참고)irqreturn_t 구조체](#참고irqreturn_t-구조체)

      2. 인터럽트 회선 할당  
        다음 단계는 인터럽트 라인을 할당하는 것이다.  
        인터럽트 줄은 특정 하드웨어 장치와 연관된 고유 식별자이다.  
        Linux에서 인터럽트 라인은 정수로 표시된다.  
        `request_irq()` 함수는 인터럽트 회선을 할당하는 데 사용된다.

      3. 인터럽트 핸들러 등록  
        인터럽트 라인이 할당되면 인터럽트 핸들러를 커널에 등록할 수 있다.  
        이 작업은 `request_irq()` 함수를 사용하여 수행된다.
          ``` c
          int request_irq(unsigned int irq, irq_handler_t handler, unsigned long flags, const char *name, void *dev);
          ```
          irq: 처리할 인터럽트 회선 번호  
          handler: 인터럽트 핸들러 함수에 대한 함수 포인터  
          flags: 인터럽트의 동작을 제어하는 플래그
          name: 인터럽트를 요청하는 장치를 식별하는 문자열  
          dev: 인터럽트를 요청하는 디바이스에 대한 포인터

      4. 인터럽트 회선 활성화  
        마지막 단계는 인터럽트 라인을 활성화하는 것이다.  
        이 작업은 `enable_irq()` 함수를 사용하여 수행된다.  
        인터럽트 회선이 활성화되면 인터럽트 핸들러가 인터럽트를 수신하기 시작한다.
          ``` c
          void enable_irq(unsigned int irq);
          ```
          irq: 활성화할 인터럽트 번호

#### (참고)irqreturn_t 구조체
``` c
#include <linux/irqreturn.h>

typedef enum {
        IRQ_NONE        = (0 << 0),
        IRQ_HANDLED     = (1 << 0),
        IRQ_WAKE_THREAD = (1 << 1),
} irqreturn_t;
```
IRQ_NONE : 인터럽트 처리기가 인터럽트를 처리하지 않았으며 다음 인터럽트 처리기(있는 경우)로 전달되어야 함  
IRQ_HANDLED : 인터럽트 핸들러가 인터럽트를 성공적으로 처리했으며 추가 조치가 필요하지 않음  
IRQ_WAKE_THREAD : 인터럽트 핸들러가 인터럽트를 처리했지만 추가 처리를 커널 스레드로 연기했음  
(커널 스레드가 깨어나서 처리를 완료하기 위해 실행됨)